<!DOCTYPE html>
<html lang="en">

<head>

<meta charset="utf-8">
<title>VRCHAT LAUNCHER LINKS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noreferrer, noopener">

<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<!--
rel="preload" means the resource is critical for render properly
<link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous">
<link rel="preload" as="script" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/js/all.min.js" crossorigin="anonymous">
<link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css" crossorigin="anonymous">
<link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/svg-with-js.min.css" crossorigin="anonymous">
-->

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/svg-with-js.min.css" integrity="sha512-vtbctC7BecZMHWPWej78RfcB9RmGpIx+G4+1IT2/Z9P7SIXApaI1XLOCrzpSKgNyTiw1VCmg/EkJXGo+LJYcpw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMjAgNTEyIj48IS0tISBGb250IEF3ZXNvbWUgRnJlZSA2LjUuMSBieSBAZm9udGF3ZXNvbWUgLSBodHRwczovL2ZvbnRhd2Vzb21lLmNvbSBMaWNlbnNlIC0gaHR0cHM6Ly9mb250YXdlc29tZS5jb20vbGljZW5zZS9mcmVlIChJY29uczogQ0MgQlkgNC4wLCBGb250czogU0lMIE9GTCAxLjEsIENvZGU6IE1JVCBMaWNlbnNlKSBDb3B5cmlnaHQgMjAyMyBGb250aWNvbnMsIEluYy4gLS0+PHBhdGggaWQ9InNldmVuIiBkPSJNMCA2NEMwIDQ2LjMgMTQuMyAzMiAzMiAzMkgyODhjMTEuNSAwIDIyIDYuMSAyNy43IDE2LjFzNS43IDIyLjItLjEgMzIuMWwtMjI0IDM4NGMtOC45IDE1LjMtMjguNSAyMC40LTQzLjggMTEuNXMtMjAuNC0yOC41LTExLjUtNDMuOEwyMzIuMyA5NkgzMkMxNC4zIDk2IDAgODEuNyAwIDY0eiIvPjx1c2UgZmlsbD0iIzAwMCIgc3Ryb2tlPSIjZmZmIiBzdHJva2Utd2lkdGg9IjEyLjUlIiBocmVmPSIjc2V2ZW4iLz4KPHVzZSBmaWxsPSIjMDAwIiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iMCIgaHJlZj0iI3NldmVuIi8+PC9zdmc+" sizes="any"> -->

<meta name="theme-color" content="#fafafa">

</head>

<style>

html, body
{
  font-language-override: "ENG";
  -webkit-locale: "en";
  line-break: strict;
  word-break: break-word;
  overflow-wrap: break-word;
  /* word-wrap: break-word; */
}

.debug-info
{
  /* margin-top: -12px; */
}

.debug-info-title, .debug-info-text
{
  font-size: .75em;
  color: #6c757d;
}

.debug-info-text
{
  font-family: monospace, monospace;  
  text-overflow: ellipsis
}

</style>

<body>

<section class="my-4">
  <div class="container">
    <header class="py-2">
      <h1 class="display-3">
        <div>VRChat Links</div>
        <!--
        <div class="visually-hidden"> | </div>
        <div class="text-secondary" style="--bs-text-opacity: .75; font-size: 60%;">7 WONDERS</div>
        -->
      </h1>
    </header>  
  </div>
</section>

<section class="my-4">
  <div class="container">
    <h3 class="display-6 my-2">Buttons</h3>
    <div class="d-flex flex-column flex-sm-row justify-content-start align-items-stretch gap-2 my-2">
      <a href="#" class="btn btn-primary shadow-sm disabled" tabindex="-1" role="button" aria-disabled="true" id="game-button"><i class="fa-solid fa-window-maximize"></i> Launch Game</a>
      <a href="#" class="btn btn-outline-primary shadow-sm disabled" tabindex="-1" role="button" aria-disabled="true" id="web-button"><i class="fa-solid fa-globe"></i> Launch Web</a>
      <a href="#" class="btn btn-info shadow-sm disabled" tabindex="-1" role="button" aria-disabled="true" id="info-button"><i class="fa-solid fa-circle-info"></i> Info Link</a>
    </div>
    <div class="mt-5 mb-2">
      <form class="border p-2 shadow-sm">
        <div class="row debug-info">
          <label for="worldid-input" class="col-sm-3 col-form-label debug-info-title py-0">World ID</label>
          <div class="col-sm-9">
            <input type="text" id="worldid-input" readonly class="form-control-plaintext debug-info-text py-0">
          </div>
        </div>        
        <div class="row debug-info">
          <label for="instancenumber-input" class="col-sm-3 col-form-label debug-info-title py-0">Instance Number</label>
          <div class="col-sm-9">
            <input type="text" id="instancenumber-input" readonly class="form-control-plaintext debug-info-text py-0">
          </div>
        </div>        
        <div class="row debug-info">
          <label for="instancetype-input" class="col-sm-3 col-form-label debug-info-title py-0">Instance Type</label>
          <div class="col-sm-9">
            <input type="text" id="instancetype-input" readonly class="form-control-plaintext debug-info-text py-0">
          </div>
        </div>        
        <div class="row debug-info">
          <label for="instanceid-input" class="col-sm-3 col-form-label debug-info-title py-0">Instance Owner</label>
          <div class="col-sm-9">
            <input type="text" id="instanceid-input" readonly class="form-control-plaintext debug-info-text py-0">
          </div>
        </div>        
        <div class="row debug-info">
          <label for="region-input" class="col-sm-3 col-form-label debug-info-title py-0">Region</label>
          <div class="col-sm-9">
            <input type="text" id="region-input" readonly class="form-control-plaintext debug-info-text py-0">
          </div>
        </div>        
        <div class="row debug-info">
          <label for="nonce-input" class="col-sm-3 col-form-label debug-info-title py-0"><em>NONCE</em></label>
          <div class="col-sm-9">
            <input type="text" id="nonce-input" readonly class="form-control-plaintext debug-info-text py-0">
          </div>
        </div>        
      </form>
    </div>
  </div>
</section>

<!--
<ul>
  <li>Launch Game Link: <span id="gamelink"></span></li>
  <li>Web Launch Link: <span id="weblink"></li>
  <li>Web Info Link: <span id="infolink"></li>
</ul>
-->
  
</body>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/js/all.min.js" integrity="sha512-b+nQTCdtTBIRIbraqNEwsjB6UvL3UEMkXnhzd8awtCYh0Kcsjl9uEgwVFVbhoj3uu1DO1ZMacNvLoyJJiNfcvg==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
<script>
// https://vrchatapi.github.io/tutorials/instances/
// https://thegreatpug.com/vrchat-link-generator/

(() =>
{

    const generateWorldLink = (worldId, _instanceNumber, _instanceType = "friend+", instanceOwner, region) =>
    {
        console.log("GENERATING LINK")
        console.log("===============")

        worldId = worldId.trim()
        _instanceNumber = _instanceNumber.trim()
        _instanceType = _instanceType.trim()
        instanceOwner = instanceOwner.trim()
        region = region.trim()

        if (!worldId)
        {
            // throw new Error("No worldId")
            console.error("No worldId")
            return
        }

        if (!_instanceType)
        {
            // throw new Error("No instanceType")
            console.error("No instanceType")
            return
        }

        if (!instanceOwner)
        {
            // throw new Error("No instanceOwner")
            console.error("No instanceOwner")
            return
        }

        if (worldId.match(/\/info$/))
        {
          worldId = worldId.replace(/\/info$/, "")
        }

        const instanceType = 
            _instanceType === "friend+" || _instanceType === "friend-plus" || _instanceType === "friends+" || _instanceType === "friends-plus" ? "hidden" :
            _instanceType === "friend" || _instanceType === "friends" ? "friends" :
            _instanceType === "invite+" || _instanceType === "invite-plus" ? "private" :
            _instanceType === "invite" ? "private" :
            "public"
        const canRequestInvite = _instanceType === "invite+" || _instanceType === "invite-plus" // Invite+ - true / other - false

        "public"
        "friends" // Friend+
        "hidden" // Friend Only
        "private" // Invite+ / Invite Only

        const instanceNumber = 
          !_instanceNumber || _instanceNumber === 0 || _instanceNumber === "0" || _instanceNumber.match(/[^A-Za-z0-9]/) ? 
          randomInstanceNumber("number-only") // Random String from "A-Za-z0-9" with Length of 5 
          : _instanceNumber

        // const region = "jp" // "us" / "use" / "eu" / "jp"

        console.log("worldID = " + worldId)
        console.log("instanceOwner = " + instanceOwner) // Group ID if creating for Group Instance or Group+ Instance
        console.log("instanceType  = " + instanceType)
        console.log("instanceNumber  = " + instanceNumber)

        const gameLink = "vrchat://launch"
        // const gameLink = "vrchat://launch?id="
        // const webLink = "https://vrchat.com/home/launch?worldId="
        const gameParams = new URLSearchParams()
        gameParams.toString = function() 
        {
          string = ""
          this.forEach((value, id) => 
          {
            if (string)
            {
              string += "&"
            }
            string += id + "=" + value
          })
          return string
        }
        const webURL = new URL("https://vrchat.com/home/launch")
        const infoURL = new URL("https://vrchat.com/home/world/")      

        // gameParams
        // webURL.searchParams

        // vrchat://launch?id=wrld_97fda4a1-f820-4f09-a88c-2d2a95b668f7:42~private(inviteurl_27e48f0e-1048-4232-9297-9d40b6dd8bc1)~nonce(A8B916551CE6C31A1D71AE89B6D76BEE5EDC0925245305SB2395A466D3B62E40)
        // vrchat://launch?id=wrld_6caf5200-70e1-46c2-b043-e3c4abe69e0f:3950~public(1J91IX00TGUBoUEmYq2yZE65UFWWGo)~nonce(vVHvCW0bwnLBGEcMqxjs36wq4YUnQV)            
        // https://vrchat.net/home/launch?  worldId=wrld_6caf5200-70e1-46c2-b043-e3c4abe69e0f   &instanceId=42~private  (96714c33-87e6-4b98-9b58-fecc42031e91)
            
        //Add on worldID and Instance Number
            
        let instanceId = ""

        //Public links dont seem to allow owners any more?
        if (instanceType === "public")
        {
            instanceId = instanceNumber
        }
        else
        {
            instanceId = instanceNumber + "~" + instanceType + "(" + instanceOwner + ")"
        }

        //If the instance is invite+ we need to add in "~canRequestInvite()"
        if (canRequestInvite === true) 
        {            
            instanceId += "~canRequestInvite"
        }
        
        if (region)
        {
            instanceId += "~region(" + region + ")"            
        }

        const tempNonce = nonce()
        if (instanceType !== "public")
        {
            instanceId += "~nonce(" + tempNonce + ")"
        }

        gameParams.set("id", worldId + ":" + instanceId)
        webURL.searchParams.set("worldId", worldId)
        webURL.searchParams.set("instanceId", instanceId)
        infoURL.pathname = infoURL.pathname.replace(/\/$/, "") + "/" + worldId

        //Output Final Link
        console.log("Launch Game Link", gameLink + "?" + gameParams.toString())
        console.log("Web Link", webURL.toString())

        //Get System's fancy new short URL link
        // loadXMLDoc(weblink + "/shortName")
        // console.log(weblink + "/shortName")            
        
        document.addEventListener("DOMContentLoaded", () => 
        {          
          const worldidInput = document.getElementById("worldid-input")
          if (worldidInput)
          {
            worldidInput.value = worldId

            worldidInput.selectionStart = 0
            worldidInput.selectionEnd = worldidInput.value.length
          }          
          const instancenumberInput = document.getElementById("instancenumber-input")
          if (instancenumberInput)
          {
            instancenumberInput.value = instanceNumber
          }
          const instancetypeInput = document.getElementById("instancetype-input")
          if (instancetypeInput)
          {
            const __instanceType = 
              _instanceType === "friend+" || _instanceType === "friend-plus" || _instanceType === "friends+" || _instanceType === "friends-plus" ? "friends+" :
              _instanceType === "friend" || _instanceType === "friends" ? "friends" :
              _instanceType === "invite+" || _instanceType === "invite-plus" ? "invite+" :
              _instanceType === "invite" ? "invite" :
              "public"
            instancetypeInput.value = __instanceType

            instancetypeInput.selectionStart = 0
            instancetypeInput.selectionEnd = instancetypeInput.value.length
          }
          const instanceidInput = document.getElementById("instanceid-input")
          if (instanceidInput)
          {
            instanceidInput.value = instanceOwner

            instanceidInput.selectionStart = 0
            instanceidInput.selectionEnd = instanceidInput.value.length
          }
          
          const regionInput = document.getElementById("region-input")
          if (regionInput)
          {
            regionInput.value = region ? region : "us"

            regionInput.selectionStart = 0
            regionInput.selectionEnd = regionInput.value.length
          }

          const nonceInput = document.getElementById("nonce-input")
          if (nonceInput)
          {
            nonceInput.value = tempNonce

            nonceInput.selectionStart = 0
            nonceInput.selectionEnd = nonceInput.value.length
          }

          const gameLinkWrapper = document.getElementById("gamelink")
          if (gameLinkWrapper)
          {
            const gameLinkElement = document.createElement("a")
            gameLinkElement.href = gameLink + "?" + gameParams.toString()
            gameLinkElement.textContent = gameLink + "?" + gameParams.toString()

            gameLinkWrapper.innerHTML = ""
            gameLinkWrapper.append(gameLinkElement)
          }

          const gameButton = document.getElementById("game-button")
          if (gameButton)
          {
            gameButton.href = gameLink + "?" + gameParams.toString()
            gameButton.tabIndex = ""
            gameButton.ariaDisabled = false        
            gameButton.classList.remove("disabled")
          }

          const webLinkWrapper = document.getElementById("weblink")
          if (webLinkWrapper)
          {
            const webLinkElement = document.createElement("a")
            webLinkElement.href = webURL.toString()
            webLinkElement.textContent = webURL.toString()

            webLinkWrapper.innerHTML = ""
            webLinkWrapper.append(webLinkElement)
          }

          const webButton = document.getElementById("web-button")
          if (webButton)
          {
            webButton.href = webURL.toString()
            webButton.tabIndex = ""
            webButton.ariaDisabled = false        
            webButton.classList.remove("disabled")
          }

          const infoLinkWrapper = document.getElementById("infolink")
          if (infoLinkWrapper)
          {
            const infoLinkElement = document.createElement("a")
            infoLinkElement.href = infoURL.toString()
            infoLinkElement.textContent = infoURL.toString()

            infoLinkWrapper.innerHTML = ""
            infoLinkWrapper.append(infoLinkElement)
          }
                          
          const infoButton = document.getElementById("info-button")
          if (infoButton)
          {
            infoButton.href = infoURL.toString()
            infoButton.tabIndex = ""
            infoButton.ariaDisabled = false        
            infoButton.classList.remove("disabled")
          }

          for (const _input of document.querySelectorAll(".debug-info-text"))
          {
            _input.addEventListener("blur", () =>
            {
              _input.selectionStart = 0
              _input.selectionEnd = _input.value.length
            })
          }

        })

        return webURL.toString()

    }

    // Generate a Random enough instance ID
    const randomWholeNum = () => Math.floor(Math.random() * 6969)
    const randomInstanceNumber = (type) => 
    {
        const length = 5 

        let result = ""
        const characters = type === "number-only" ? "0123456789" : "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"        
        let counter = 0
        for (let i = 0; i < length; i++)        
        {
            result += characters.charAt(Math.floor(Math.random() * characters.length))            
        }
        return result
    }

    //Generate random enough nonce
    const nonce = () =>
    {    

        const temp_url = URL.createObjectURL(new Blob())
        const uuid = temp_url.toString()
        URL.revokeObjectURL(temp_url)
        return uuid.split(/[:\/]/g).pop().toLowerCase() // remove prefixes

    }

    const main = () =>
    {
        const getParamsFromURL = new URL(location)
        const worldId = getParamsFromURL.searchParams.get("w") 
        const instanceNumber = getParamsFromURL.searchParams.get("n")
        const instanceType = getParamsFromURL.searchParams.get("t") 
        const instanceOwner = getParamsFromURL.searchParams.get("i")
        const region = getParamsFromURL.searchParams.get("r")
        const automaticallyRedirect = getParamsFromURL.searchParams.get("a").trim()

        const webURL = generateWorldLink(worldId, instanceNumber, instanceType, instanceOwner, region)

        if (!!automaticallyRedirect && automaticallyRedirect !== "" && automaticallyRedirect !== "0" && automaticallyRedirect !== "off" && automaticallyRedirect !== "false")
        {
            location.href = webURL.toString()
        }        
    }

    main()

})()
</script>

</html>
