<!DOCTYPE html>
<html lang="en">

<head>

<meta charset="utf-8">
<title>VRCHAT LAUNCHER LINKS</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noreferrer, noopener">

<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<!--
rel="preload" means the resource is critical for render properly
<link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous">
<link rel="preload" as="script" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/js/all.min.js" crossorigin="anonymous">
<link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css" crossorigin="anonymous">
<link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/svg-with-js.min.css" crossorigin="anonymous">
-->

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/svg-with-js.min.css" integrity="sha512-vtbctC7BecZMHWPWej78RfcB9RmGpIx+G4+1IT2/Z9P7SIXApaI1XLOCrzpSKgNyTiw1VCmg/EkJXGo+LJYcpw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMjAgNTEyIj48IS0tISBGb250IEF3ZXNvbWUgRnJlZSA2LjUuMSBieSBAZm9udGF3ZXNvbWUgLSBodHRwczovL2ZvbnRhd2Vzb21lLmNvbSBMaWNlbnNlIC0gaHR0cHM6Ly9mb250YXdlc29tZS5jb20vbGljZW5zZS9mcmVlIChJY29uczogQ0MgQlkgNC4wLCBGb250czogU0lMIE9GTCAxLjEsIENvZGU6IE1JVCBMaWNlbnNlKSBDb3B5cmlnaHQgMjAyMyBGb250aWNvbnMsIEluYy4gLS0+PHBhdGggaWQ9InNldmVuIiBkPSJNMCA2NEMwIDQ2LjMgMTQuMyAzMiAzMiAzMkgyODhjMTEuNSAwIDIyIDYuMSAyNy43IDE2LjFzNS43IDIyLjItLjEgMzIuMWwtMjI0IDM4NGMtOC45IDE1LjMtMjguNSAyMC40LTQzLjggMTEuNXMtMjAuNC0yOC41LTExLjUtNDMuOEwyMzIuMyA5NkgzMkMxNC4zIDk2IDAgODEuNyAwIDY0eiIvPjx1c2UgZmlsbD0iIzAwMCIgc3Ryb2tlPSIjZmZmIiBzdHJva2Utd2lkdGg9IjEyLjUlIiBocmVmPSIjc2V2ZW4iLz4KPHVzZSBmaWxsPSIjMDAwIiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iMCIgaHJlZj0iI3NldmVuIi8+PC9zdmc+" sizes="any"> -->

<meta name="theme-color" content="#fafafa">

</head>

<style>

html, body
{
  font-language-override: "ENG";
  -webkit-locale: "en";
  line-break: strict;
  word-break: break-word;
  overflow-wrap: break-word;
  /* word-wrap: break-word; */
}

.debug-info
{
  /* margin-top: -12px; */
}

.debug-info-title, .debug-info-text
{
  font-size: .75em;
  color: #6c757d;
}

.debug-info-text
{
  font-family: monospace, monospace;
  text-overflow: ellipsis
}

</style>

<body>

<section class="my-4">
  <div class="container">
    <header class="py-2">
      <h1 class="display-3">
        <div>VRChat Links</div>
        <!--
        <div class="visually-hidden"> | </div>
        <div class="text-secondary" style="--bs-text-opacity: .75; font-size: 60%;">7 WONDERS</div>
        -->
      </h1>
    </header>
  </div>
</section>

<section class="my-4">
  <div class="container">
    <h3 class="display-6 my-2">Buttons</h3>
    <div class="d-flex flex-column flex-sm-row justify-content-start align-items-stretch gap-2 my-2">
      <a href="#" class="btn btn-primary shadow-sm disabled" tabindex="-1" role="button" aria-disabled="true" id="game-button"><i class="fa-solid fa-window-maximize"></i> Launch Game</a>
      <a href="#" class="btn btn-outline-primary shadow-sm disabled" tabindex="-1" role="button" aria-disabled="true" id="web-button"><i class="fa-solid fa-globe"></i> Launch Web</a>
      <a href="#" class="btn btn-info shadow-sm disabled" tabindex="-1" role="button" aria-disabled="true" id="info-button"><i class="fa-solid fa-circle-info"></i> Info Link</a>
    </div>
    <div class="mt-5 mb-2">
      <form class="border shadow-sm">
        <nav>
          <div class="nav nav-tabs px-2 pt-2" id="nav-tab" role="tablist">
            <button class="nav-link active" id="nav-debug-tab" data-bs-toggle="tab" data-bs-target="#nav-debug" type="button" role="tab" aria-controls="nav-debug" aria-selected="true">Debug</button>
            <button class="nav-link" id="nav-manual-tab" data-bs-toggle="tab" data-bs-target="#nav-manual" type="button" role="tab" aria-controls="nav-manual" aria-selected="false">Manual Input</button>
            <button class="nav-link" id="nav-world-tab" data-bs-toggle="tab" data-bs-target="#nav-world" type="button" role="tab" aria-controls="nav-world" aria-selected="false">World Data</button>
            <button class="nav-link" id="nav-text-tab" data-bs-toggle="tab" data-bs-target="#nav-text" type="button" role="tab" aria-controls="nav-text" aria-selected="false">Text Chip</button>
          </div>
        </nav>
        <div class="tab-content m-2" id="nav-tabContent">
          <div class="tab-pane fade show active" id="nav-debug" role="tabpanel" aria-labelledby="nav-debug-tab" tabindex="0">
            <div class="row debug-info">
              <label for="worldid-box" class="col-sm-4 col-form-label debug-info-title py-0">World ID</label>
              <div class="col-sm-8">
                <input type="text" id="worldid-box" readonly class="form-control-plaintext debug-info-text py-0">
              </div>
            </div>
            <div class="row debug-info">
              <label for="instancenumber-box" class="col-sm-4 col-form-label debug-info-title py-0">Instance Number <span id="instancenumber-text" class="text-body fst-italic"></span></label>
              <div class="col-sm-8">
                <input type="text" id="instancenumber-box" readonly class="form-control-plaintext debug-info-text py-0">
              </div>
            </div>
            <div class="row debug-info">
              <label for="instancetype-box" class="col-sm-4 col-form-label debug-info-title py-0">Instance Type</label>
              <div class="col-sm-8">
                <input type="text" id="instancetype-box" readonly class="form-control-plaintext debug-info-text py-0">
              </div>
            </div>
            <div class="row debug-info">
              <label for="instanceid-box" class="col-sm-4 col-form-label debug-info-title py-0">Instance Owner</label>
              <div class="col-sm-8">
                <input type="text" id="instanceid-box" readonly class="form-control-plaintext debug-info-text py-0">
              </div>
            </div>
            <div class="row debug-info">
              <label for="region-box" class="col-sm-4 col-form-label debug-info-title py-0">Region</label>
              <div class="col-sm-8">
                <input type="text" id="region-box" readonly class="form-control-plaintext debug-info-text py-0">
              </div>
            </div>
            <div class="row debug-info">
              <label for="nonce-box" class="col-sm-4 col-form-label debug-info-title py-0"><span class="fst-italic">NONCE</span> <span id="nonce-text" class="text-body fst-italic"></span></label>
              <div class="col-sm-8">
                <input type="text" id="nonce-box" readonly class="form-control-plaintext debug-info-text py-0">
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="nav-manual" role="tabpanel" aria-labelledby="nav-manual-tab" tabindex="0">
            <div class="row mb-2 manual-input">
              <label for="worldid-input" class="col-sm-4 col-form-label manual-input-title py-0">World ID</label>
              <div class="col-sm-8">
                <input type="text" id="worldid-input" class="form-control manual-input-text py-0">
              </div>
            </div>
            <div class="row mb-2 manual-input">
              <label for="instancenumber-input" class="col-sm-4 col-form-label manual-input-title py-0">Instance Number <span id="instancenumber-text" class="text-body fst-italic"></span></label>
              <div class="col-sm-8">
                <input type="text" id="instancenumber-input" class="form-control manual-input-text py-0">
              </div>
            </div>
            <div class="row mb-2 manual-input">
              <label for="instancetype-input" class="col-sm-4 col-form-label manual-input-title py-0">Instance Type</label>
              <div class="col-sm-8">
                <select class="form-select" id="instancetype-input" class="form-control manual-input-text py-0" aria-label="Select Instance Type">
                  <option value="public">Public</option>
                  <option value="friend+">Friend+</option>
                  <option value="friend">Friend</option>
                  <option value="invite+">Invite+</option>
                  <option value="invite">Invite</option>
                </select>
              </div>
            </div>
            <div class="row mb-2 manual-input">
              <label for="instanceid-input" class="col-sm-4 col-form-label manual-input-title py-0">Instance Owner</label>
              <div class="col-sm-8">
                <input type="text" id="instanceid-input" class="form-control manual-input-text py-0">
              </div>
            </div>
            <div class="row mb-2 manual-input">
              <label for="region-input" class="col-sm-4 col-form-label manual-input-title py-0">Region</label>
              <div class="col-sm-8">
                <select class="form-select" id="region-input" class="form-control manual-input-text py-0" aria-label="Select Region">
                  <option value="us">United State West</option>
                  <option value="use">United State East</option>
                  <option value="eu">Europe</option>
                  <option value="jp">Japan</option>
                </select>
              </div>
            </div>
            <div class="row manual-input">
              <label for="nonce-input" class="col-sm-4 col-form-label manual-input-title py-0"><span class="fst-italic">NONCE</span> <span id="nonce-text" class="text-body fst-italic"></span></label>
              <div class="col-sm-8">
                <input type="text" id="nonce-input" class="form-control manual-input-text py-0">
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="nav-world" role="tabpanel" aria-labelledby="nav-world-tab" tabindex="0">
            Under Construction
            <!--
            data.id
            data.name
            data.description
            data.authorName / data.authorId
            data.recommendedCapacity / data.capacity
            "https://vrchat.com/home/user/" + data.authorId
            data.imageUrl
            data.thumbnailImageUrl
            -->
          </div>
          <div class="tab-pane fade" id="nav-text" role="tabpanel" aria-labelledby="nav-text-tab" tabindex="0">
            <textarea id="text-chip-textarea"></textarea>
          </div>
        </div>
      </form>
    </div>
  </div>
</section>

<!--
<ul>
  <li>Launch Game Link: <span id="gamelink"></span></li>
  <li>Web Launch Link: <span id="weblink"></li>
  <li>Web Info Link: <span id="infolink"></li>
</ul>
-->

</body>

<script src="https://cdn.jsdelivr.net/npm/js-cookie@3/dist/js.cookie.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/js/all.min.js" integrity="sha512-b+nQTCdtTBIRIbraqNEwsjB6UvL3UEMkXnhzd8awtCYh0Kcsjl9uEgwVFVbhoj3uu1DO1ZMacNvLoyJJiNfcvg==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
<script>
// https://vrchatapi.github.io/tutorials/instances/
// https://thegreatpug.com/vrchat-link-generator/

(() =>
{

    const instance =
    {
      set instanceType(type)
      {
        this._instanceType = type
      },

      get instanceType()
      {
          return this._instanceType === "friend+" || this._instanceType === "friend-plus" || this._instanceType === "friends+" || this._instanceType === "friends-plus" ? "friend+" :
            this._instanceType === "friend" || this._instanceType === "friends" ? "friend" :
            this._instanceType === "invite+" || this._instanceType === "invite-plus" ? "invite+" :
            this._instanceType === "invite" ? "invite" :
            "public"
      },

      get instanceAPIType()
      {
          return this._instanceType === "friend+" || this._instanceType === "friend-plus" || this._instanceType === "friends+" || this._instanceType === "friends-plus" ? "hidden" :
            this._instanceType === "friend" || this._instanceType === "friends" ? "friends" :
            this._instanceType === "invite+" || this._instanceType === "invite-plus" ? "private" :
            this._instanceType === "invite" ? "private" :
            "public"
      },

      get canRequestInvite()
      {
        return this._instanceType === "invite+" || this._instanceType === "invite-plus"
      },

      set nonce(uuid)
      {
        this._nonce = uuid
        this.isNonceReused = true
      },

      get nonce()
      {
        if (!this._nonce)
        {
          this._nonce = generateNonce()
          this.isNonceGenerated = true
        }

        return this._nonce
      },

      set instanceOwner(owner)
      {
        this._instanceOwner = owner
        Cookies.set("instanceOwner", owner, { expires: 30, path: "", })
      },

      get instanceOwner()
      {
        if (!this._instanceOwner)
        {
          const owner = Cookies.get("instanceOwner")
          if (owner)
          {
            this._instanceOwner = owner
          }
        }

        return this._instanceOwner
      },

      set instanceNumber(number)
      {
        this._instanceNumber = number
        this.isInstanceNumberSpecified = true
      },

      get instanceNumber()
      {
        if (!this._instanceNumber || this._instanceNumber === 0 || this._instanceNumber === "0" || this._instanceNumber.match(/[^A-Za-z0-9]/))
        {
          this._instanceNumber = randomInstanceNumber("number-only") // Random String from "A-Za-z0-9" with Length of 5
          this._isInstanceNumberGenerated = true
        }

        return this._instanceNumber
      },

      __gameLink: "vrchat://launch",
      // __gameLink: "vrchat://launch?id=",
      // __webLink: "https://vrchat.com/home/launch?worldId=",
      __gameParams: (() =>
      {
        const gameParams = new URLSearchParams()
        gameParams.toString = function()
        {
          string = ""
          this.forEach((value, id) =>
          {
            if (string)
            {
              string += "&"
            }
            string += id + "=" + value
          })
          return string
        }
        return gameParams
      })(),

      __webURL: new URL("https://vrchat.com/home/launch"),
      __infoURL: new URL("https://vrchat.com/home/world/"),
      __homeURL: new URL("https://vrchat.com/home"),

      get instanceId()
      {
        if (!this.instanceOwner && this.instanceAPIType !== "public")
        {
            // throw new Error("No instanceOwner")
            console.error("No instanceOwner for non-public instance")
            return ""
        }

        let instanceId = ""

        // Public links dont seem to allow owners any more?
        if (this.instanceAPIType === "public")
        {
            instanceId = this.instanceNumber
        }
        else
        {
            instanceId = this.instanceNumber + "~" + this.instanceAPIType + "(" + this.instanceOwner + ")"
        }

        //If the instance is invite+ we need to add in "~canRequestInvite()"
        if (this.canRequestInvite === true)
        {
            instanceId += "~canRequestInvite"
        }

        if (this.region)
        {
            instanceId += "~region(" + this.region + ")"
        }

        if (this.instanceAPIType !== "public")
        {
            instanceId += "~nonce(" + this.nonce + ")"
        }

        return instanceId
      },

      get gameLink()
      {
        if (this.worldId)
        {
          this.__gameParams.set("id", this.worldId + ":" + this.instanceId)
          return this.__gameLink + "?" + this.__gameParams.toString()
        }
        else
        {
          return this.__gameLink
        }
      },

      get webURL()
      {
        if (this.worldId)
        {
          this.__webURL.searchParams.set("worldId", this.worldId)
          this.__webURL.searchParams.set("instanceId", this.instanceId)
          return this.__webURL.toString()
        }
        else
        {
          return this.__homeURL.toString()
        }
      },

      get infoURL()
      {
        if (this.worldId)
        {
          return this.__infoURL.pathname.replace(/\/$/, "") + "/" + this.worldId
        }
        else
        {
          return this.__homeURL.toString()
        }
      },

      get thisURL()
      {
        const _u = new URL(location)
        _u.searchParams.set("w", this.worldId)
        _u.searchParams.set("n", this.instanceNumber)
        if (this._instanceType)
        {
          _u.searchParams.set("t", this._instanceType)
        }
        if (this.instanceOwner)
        {
          _u.searchParams.set("i", this.instanceOwner)
        }
        if (this.region)
        {
          _u.searchParams.set("r", this.region)
        }
        if (this.nonce)
        {
          _u.searchParams.set("x", this.nonce)
        }

        return _u.toString()
      }
    }

    const world =
    {

    }

    const generateWorldLink = data =>
    {
        console.log("GENERATING LINK")
        console.log("===============")

        if (data.worldId && data.worldId.trim)
        {
          instance.worldId = data.worldId.trim()
          if (instance.worldId.match(/\/info$/))
          {
            instance.worldId = instance.worldId.replace(/\/info$/, "")
          }
        }
        if (data.instanceNumber && data.instanceNumber.trim)
        {
          instance.instanceNumber = data.instanceNumber.trim()
        }
        if (data.instanceType && data.instanceType.trim)
        {
          instance.instanceType = data.instanceType.trim()
        }
        if (data.instanceOwner && data.instanceOwner.trim)
        {
          instance.instanceOwner = data.instanceOwner.trim()
        }
        if (data.region && data.region.trim)
        {
          instance.region = data.region.trim()
        }

        if (!instance.worldId)
        {
            // throw new Error("No worldId")
            console.error("No worldId")
            return
        }

        // if (!_instanceType)
        // {
        //     // throw new Error("No instanceType")
        //     console.error("No instanceType")
        //     return
        // }

        console.log(instance)
        if (!instance.instanceOwner && instance.instanceAPIType !== "public")
        {
            // throw new Error("No instanceOwner")
            console.error("No instanceOwner for non-public instance")
            return
        }

        "public"
        "friends" // Friend+
        "hidden" // Friend Only
        "private" // Invite+ / Invite Only

        // const region = "jp" // "us" / "use" / "eu" / "jp"

        console.log("worldID = " + instance.worldId)
        console.log("instanceOwner = " + instance.instanceOwner) // Group ID if creating for Group Instance or Group+ Instance
        console.log("instanceType  = " + instance.instanceAPIType)
        console.log("instanceNumber  = " + instance.instanceNumber)

        //Output Final Link
        console.log("Launch Game Link", instance.gameLink)
        console.log("Web Link", instance.webURL)

        //Get System's fancy new short URL link
        // loadXMLDoc(weblink + "/shortName")
        // console.log(weblink + "/shortName")

        document.addEventListener("DOMContentLoaded", () =>
        {

          setFormInput()
          updateLink()
          initializeDebugFormBlurSelection()
        })

        // return instance.webURL.toString()

    }

    const setFormInput = () =>
    {

      const worldidBox = document.getElementById("worldid-box")
      if (worldidBox)
      {
        worldidBox.value = instance.worldId

        worldidBox.selectionStart = 0
        worldidBox.selectionEnd = worldidBox.value.length
      }
      const worldidInput = document.getElementById("worldid-input")
      if (worldidInput)
      {
        worldidInput.value = instance.worldId

        worldidInput.selectionStart = 0
        worldidInput.selectionEnd = worldidInput.value.length
      }

      const instancenumberBox = document.getElementById("instancenumber-box")
      if (instancenumberBox)
      {
        instancenumberBox.value = instance.instanceNumber
        const instancenumberText = document.getElementById("instancenumber-text")
        if (instancenumberText)
        {
          instancenumberText.innerHTML = this.isInstanceNumberSpecified ? "(Specified)" : ""
        }
      }
      const instancenumberInput = document.getElementById("instancenumber-input")
      if (instancenumberInput)
      {
        instancenumberInput.value = instance.instanceNumber
      }

      const instancetypeBox = document.getElementById("instancetype-box")
      if (instancetypeBox)
      {
        instancetypeBox.value = instance.instanceAPIType

        instancetypeBox.selectionStart = 0
        instancetypeBox.selectionEnd = instancetypeBox.value.length
      }
      const instancetypeInput = document.getElementById("instancetype-input")
      if (instancetypeInput)
      {
        const options = Array.from(instancetypeInput.options).map(option => option.value)
        instancetypeInput.selectedIndex = options.indexOf(instance.instanceType)

        // instancetypeInput.selectionStart = 0
        // instancetypeInput.selectionEnd = instancetypeInput.value.length
      }

      const instanceidBox = document.getElementById("instanceid-box")
      if (instanceidBox)
      {
        instanceidBox.value = instance.instanceOwner || ""

        instanceidBox.selectionStart = 0
        instanceidBox.selectionEnd = instanceidBox.value.length
      }
      const instanceidInput = document.getElementById("instanceid-input")
      if (instanceidInput)
      {
        instanceidInput.value = instance.instanceOwner || ""

        instanceidInput.selectionStart = 0
        instanceidInput.selectionEnd = instanceidInput.value.length
      }

      const regionBox = document.getElementById("region-box")
      if (regionBox)
      {
        regionBox.value = instance.region || "us"

        regionBox.selectionStart = 0
        regionBox.selectionEnd = regionBox.value.length
      }
      const regionInput = document.getElementById("region-input")
      if (regionInput)
      {
        const options = Array.from(regionInput.options).map(option => option.value)
        regionInput.selectedIndex = options.indexOf(instance.region || "us")

        // regionInput.selectionStart = 0
        // regionInput.selectionEnd = regionInput.value.length
      }

      const nonceBox = document.getElementById("nonce-box")
      if (nonceBox)
      {
        nonceBox.value = instance.nonce
        const nonceText = document.getElementById("nonce-text")
        if (nonceText)
        {
          nonceText.innerHTML = instance.isNonceReused ? "(Reused)" : ""

        }

        nonceBox.selectionStart = 0
        nonceBox.selectionEnd = nonceBox.value.length
      }
      const nonceInput = document.getElementById("nonce-input")
      if (nonceInput)
      {
        nonceInput.value = instance.nonce

        nonceInput.selectionStart = 0
        nonceInput.selectionEnd = nonceInput.value.length
      }

    }

    const initializeDebugFormBlurSelection = () =>
    {

      for (const _input of document.querySelectorAll(".debug-info-text"))
      {
        _input.addEventListener("blur", () =>
        {
          _input.selectionStart = 0
          _input.selectionEnd = _input.value.length
        })
      }

    }

    const updateLink = () =>
    {

      const gameLinkWrapper = document.getElementById("gamelink")
      if (gameLinkWrapper)
      {
        const gameLinkElement = document.createElement("a")
        gameLinkElement.href = instance.gameLink
        gameLinkElement.textContent = instance.gameLink

        gameLinkWrapper.innerHTML = ""
        gameLinkWrapper.append(gameLinkElement)
      }

      const gameButton = document.getElementById("game-button")
      if (gameButton)
      {
        gameButton.href = instance.gameLink
        gameButton.tabIndex = ""
        gameButton.ariaDisabled = false
        gameButton.classList.remove("disabled")
      }

      const webLinkWrapper = document.getElementById("weblink")
      if (webLinkWrapper)
      {
        const webLinkElement = document.createElement("a")
        webLinkElement.href = instance.webURL
        webLinkElement.textContent = instance.webURL

        webLinkWrapper.innerHTML = ""
        webLinkWrapper.append(webLinkElement)
      }

      const webButton = document.getElementById("web-button")
      if (webButton)
      {
        webButton.href = instance.webURL
        webButton.tabIndex = ""
        webButton.ariaDisabled = false
        webButton.classList.remove("disabled")
      }

      const infoLinkWrapper = document.getElementById("infolink")
      if (infoLinkWrapper)
      {
        const infoLinkElement = document.createElement("a")
        infoLinkElement.href = instance.infoURL
        infoLinkElement.textContent = instance.infoURL

        infoLinkWrapper.innerHTML = ""
        infoLinkWrapper.append(infoLinkElement)
      }

      const infoButton = document.getElementById("info-button")
      if (infoButton)
      {
        infoButton.href = instance.infoURL
        infoButton.tabIndex = ""
        infoButton.ariaDisabled = false
        infoButton.classList.remove("disabled")
      }

    }

    // Generate a Random enough instance ID
    const randomWholeNum = () => Math.floor(Math.random() * 6969)
    const randomInstanceNumber = (type) =>
    {
        const length = 5

        let result = ""
        const characters = type === "number-only" ? "0123456789" : "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
        let counter = 0
        for (let i = 0; i < length; i++)
        {
            result += characters.charAt(Math.floor(Math.random() * characters.length))
        }
        return result
    }

    //Generate random enough nonce
    const generateNonce = () =>
    {

        const temp_url = URL.createObjectURL(new Blob())
        const uuid = temp_url.toString()
        URL.revokeObjectURL(temp_url)
        return uuid.split(/[:\/]/g).pop().toLowerCase() // remove prefixes

    }

    const getDataFromUrl = url =>
    {
      const _url = new URL(url)
      const data = {}

      if (_url.hostname === "vrchat.com" || _url.hostname === "www.vrchat.com")
      {
        if (data.matches = _url.pathname.match(/^\/home\/world\/(wrld_[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12})/))
        {
          data.worldId = data.matches[1]
          return data
        }

        if (_url.pathname.match(/^\/home\/launch/))
        {
          data.worldId = _url.searchParams.get("worldId")

          const instanceId = _url.searchParams.get("instanceId")
          const instanceData = instanceId.split("~")

          const _parsedData = []
          let _parsedId = 0
          let _dataId = 0
          while (_dataId < instanceData.length)
          {
            switch (_parsedId)
            {
            case 0:
              _parsedData[_parsedId] = instanceData[_dataId]
              _dataId++
              break;
            case 1:
              if (data.matches = instanceData[_dataId].match(/^(private|public|hidden|friends)\((.+?)\)/))
              {
                _parsedData[_parsedId] =
                {
                  type: data.matches[1],
                  owner: data.matches[2],
                }
                _dataId++
              }
              else
              {
                _parsedData[_parsedId] = { type: "public" }
              }
              break;
            case 2:
              if (instanceData[_dataId] === "canRequestInvite")
              {
                _parsedData[_parsedId] = true
                _dataId++
              }
              break;
            case 3:
              if (data.matches = instanceData[_dataId].match(/^region\((.+?)\)/))
              {
                _parsedData[_parsedId] = data.matches[1]
                _dataId++
              }
              break;
            case 4:
              if (data.matches = instanceData[_dataId].match(/^nonce\((.+?)\)/))
              {
                _parsedData[_parsedId] = data.matches[1]
                _dataId++
              }
              break;
            }

            // instanceData[_dataId]

            _parsedId++
          }

          data.instanceNumber = _parsedData[0]
          data.instanceType =
            _parsedData[1].type === "hidden" ? "friend+" :
            _parsedData[1].type === "friends" ? "friend" :
            _parsedData[1].type === "private" && _parsedData[2] ? "invite+" :
            _parsedData[1].type === "private" ? "invite" :
            "public"
          if (_parsedData[1].owner)
          {
            data.instanceOwner = _parsedData[1].owner
          }
          if (_parsedData[3])
          {
            data.region = _parsedData[3]
          }
          if (_parsedData[4])
          {
            data.nonce  = _parsedData[4]
          }

          return data
        }
      }

      if (_url.hostname === "pokemonleo.github.io")
      {
        if (_url.pathname.match(/^\/vrchat-launcher\.html/))
        {
          const __w = _url.searchParams.get("w")
          if (__w)
          {
            data.worldId = __w
          }
          const __n = _url.searchParams.get("n")
          if (__n)
          {
            data.instanceNumber = __n
          }
          const __t = _url.searchParams.get("t")
          if (__t)
          {
            data.instanceType = __t
          }
          const __i = _url.searchParams.get("i")
          if (__i)
          {
            data.instanceOwner = __i
          }
          const __r = _url.searchParams.get("r")
          if (__r)
          {
            data.region = __r
          }
          const __x = _url.searchParams.get("x")
          if (__x)
          {
            data.nonce = __x
          }

          return data
        }
      }
    }

    const getWorldById = async (worldId, authCookie) =>
    {
      if (!worldId)
      {
        console.error("No World ID for Fetching")
        return
      }

      if (!worldId.match(/^wrld_[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}$/))
      {
        console.error("World ID Wrong Format for Fetching")
        return
      }

      console.log("Fetching World By ID: " + worldId)
      return await __getDataById("https://api.vrchat.cloud/api/1/worlds/" + worldId)
    }

    const getUserById = async (userId, authCookie) =>
    {
      if (!userId)
      {
        console.error("No User ID for Fetching")
        return
      }

      if (!userId.match(/^usr_[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}$/))
      {
        console.error("User ID Wrong Format for Fetching")
        return
      }

      if (!authCookie)
      {
        console.error("No Auth Cookie to Get User")
        return
      }

      console.log("Fetching User By ID: " + userId)
      return await __getDataById("https://api.vrchat.cloud/api/1/users/" + userId)
    }

    const getGroupById = async (groupId, authCookie) =>
    {
      if (!groupId)
      {
        console.error("No Group ID for Fetching")
        return
      }

      if (!groupId.match(/^grp_[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}$/))
      {
        console.error("Group ID Wrong Format for Fetching")
        return
      }

      if (!authCookie)
      {
        console.error("No Auth Cookie to Get Group")
        return
      }

      console.log("Fetching Group By ID: " + groupId)
      return await __getDataById("https://api.vrchat.cloud/api/1/groups/" + groupId)
    }

    const __getDataById = async (url) =>
    {
      const response = await fetch(url)
      if (!response.ok)
      {
        return
      }

      try
      {
        const data = await response.json()
        return data
      }
      catch (error)
      {
        console.error("Fetching Error")
        console.log("Fetching URL: " + url)
        console.log(error)
      }
    }

    const main = () =>
    {
        const getParamsFromURL = new URL(location)
        const data = {
          // worldId,
          // instanceNumber,
          // instanceType,
          // instanceOwner,
          // region,
          // nonce,
        }

        const parsingURL = getParamsFromURL.searchParams.get("p")

        if (parsingURL)
        {
          const {
            worldId,
            instanceNumber,
            instanceType,
            instanceOwner,
            region,
            nonce,
          } = getDataFromUrl(parsingURL)

          if (worldId)
          {
            data.worldId = worldId
          }
          if (instanceNumber)
          {
            data.instanceNumber = instanceNumber
          }
          if (instanceType)
          {
            data.instanceType = instanceType
          }
          if (instanceOwner)
          {
            data.instanceOwner = instanceOwner
          }
          if (region)
          {
            data.region = region
          }
          if (nonce)
          {
            data.nonce = nonce
          }
        }

        if (!data.worldId)
        {
          const __worldId = getParamsFromURL.searchParams.get("w")
          data.worldId = __worldId
        }
        if (!data.instanceNumber)
        {
          const __instanceNumber = getParamsFromURL.searchParams.get("n")
          data.instanceNumber = __instanceNumber
        }
        if (!data.instanceType)
        {
          const __instanceType = getParamsFromURL.searchParams.get("t")
          data.instanceType = __instanceType
        }
        if (!data.instanceOwner)
        {
          const __instanceOwner = getParamsFromURL.searchParams.get("i")
          data.instanceOwner = __instanceOwner
        }
        if (!data.region)
        {
          const __region = getParamsFromURL.searchParams.get("r")
          data.region = __region
        }
        if (!data.nonce)
        {
          const __nonce = getParamsFromURL.searchParams.get("x")
          data.nonce = __nonce
        }

        generateWorldLink(data)

        const isAutomaticallyRedirect = getParamsFromURL.searchParams.get("a")
        if (instance.webURL && !isVoid(isAutomaticallyRedirect))
        {
          history.replaceState(null, undefined, instance.thisURL)
          location.href = instance.webURL
        }
    }

    const isVoid = obj =>
    {
      if (!obj)
      {
        return true
      }

      if (obj === 0)
      {
        return true
      }

      if (obj.trim)
      {
        obj.trim()
      }

      if (obj === "")
      {
        return true
      }

      if (obj === "0")
      {
        return true
      }


      if (obj === "off")
      {
        return true
      }

      if (obj === "false")
      {
        return true
      }

      return false
    }

    main()

})()
</script>

</html>
